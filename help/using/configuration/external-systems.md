---
solution: Journey Optimizer
product: journey optimizer
title: Journey Optimizer と外部システムの統合
description: Journey Optimizer を外部システムと統合する際のベストプラクティスを説明します
feature: Integrations
role: User
level: Beginner
keywords: 外部, API, Optimizer, キャップ
exl-id: 27859689-dc61-4f7a-b942-431cdf244455
source-git-commit: e7908a328a14b307f0ea6914d2d06c5325ceb211
workflow-type: ht
source-wordcount: '1615'
ht-degree: 100%

---

# 外部システムとの統合 {#external-systems}

このページでは、外部システムと統合するときに Journey Optimizer が提供する、さまざまなガードレールを紹介します。また、Capping API で外部システムを最適に保護する方法、ジャーニータイムアウトを設定する方法、再試行の仕組みなどのベストプラクティスも紹介します。

Journey Optimizer では、カスタムデータソースとカスタムアクションを使用して、外部システムへの接続を設定できます。 これにより、例えば、外部の予約システムからのデータを使用してジャーニーを充実させたり、Epsilon や Facebook などのサードパーティシステムを使用してメッセージを送信したりできます。

外部システムを統合する際には、問題がいくつも発生したり、システムが低速になったり、応答が停止したり、大量の処理を行えなくなったりする場合があります。 Journey Optimizer には、システムを過負荷から保護するためにいくつかのガードレールがあります。

外部システムのパフォーマンスはさまざまです。 使用例に合わせて設定を調整する必要があります。

Journey Optimizer が外部 API を呼び出すと、次のようなテクニカルガードレールを実行します。

1. キャップルールまたはスロットルルールの適用。処理数のキャップに達すると、残りの呼び出しは破棄されるかキューに入れられます。

1. タイムアウトと再試行：キャップルールまたはスロットルルールが適用された場合、Journey Optimizer はタイムアウト期間が終了するまで呼び出しを実行しようとします。

>[!TIP]
>
>有効期限の不一致と 401 エラーを回避するために、特にワークロードが大きい場合は、外部 API のトークンの有効期限と Journey Optimizer の [`cacheDuration` 設定](../datasource/external-data-sources.md#custom-authentication-access-token)の間に 1 分以上のバッファーを残すことをお勧めします。

## Capping API と Throttling API {#capping}

### Capping API とThrottling API について

データソースやアクションを設定する際は、システムへの接続を確立して、ジャーニーで使用する追加情報を取得するか、メッセージや API 呼び出しを送信します。

ジャーニー API では 1 秒あたり最大 5,000 イベントをサポートしていますが、一部の外部システムや API は同等のスループットを持たない場合があります。これらのシステムの過負荷を防ぐために、**Capping** API と **Throttling** API を使用して、1 秒あたりに送信されるイベントの数をキャップできます。

API 呼び出しがジャーニーによって実行されるたびに、API エンジンを通過します。API で設定されたキャップに達すると、Capping API を使用している場合は呼び出しが拒否され、Throttling API を使用している場合は最大 6 時間キューに入れられ、受信した順序でできるだけ早く処理されます。

例えば、外部システムに対して 1 秒あたり 200 呼び出しまで、というキャップルールまたはスロットルルールを定義したとします。システムは、10 件の異なるジャーニーでカスタムアクションによって呼び出されます。1 つのジャーニーで 1 秒間に 300 件の呼び出しを受け取った場合、使用可能な 200 個のスロットを使用し、残りの 100 個のスロットを破棄するかキューに入れます。最大レートを超えたので、他の 9 つのジャーニーにはスロットは残りません。この精度は、外部システムを過負荷やクラッシュから保護するのに役立ちます。

>[!IMPORTANT]
>
>**キャップルール**&#x200B;は、特定のエンドポイント（呼び出された URL）に対してサンドボックスレベルで設定されますが、そのサンドボックスのすべてのジャーニーにグローバルに適用されます。キャップは、データソースとカスタムアクションの両方で使用できます。
>
>**スロットルルール**&#x200B;は、特定のエンドポイントに対して実稼動サンドボックスでのみ設定されますが、すべてのサンドボックスのすべてのジャーニーにグローバルに適用されます。組織ごとに 1 つのスロットル設定のみを指定できます。スロットルは、カスタムアクションでのみ使用できます。
>
>**maxCallsCount** 値は、1 より大きくする必要があります。

API の使用方法について詳しくは、次の節を参照してください。

* [Capping API](capping.md)
* [Throttling API](throttling.md)

API について詳しくは、[Adobe Journey Optimizer API ドキュメント](https://developer.adobe.com/journey-optimizer-apis/references/journeys/)を参照してください。

### データソースとカスタムアクションの処理能力 {#capacity}

**外部データソース**&#x200B;の場合、1 秒あたりの最大呼び出し回数は 15 に制限されています。この上限を超えると、使用中の API に応じて、追加の呼び出しは破棄されるかキューに入れられます。アドビに連絡して許可リストにエンドポイントを含めることにより、プライベート外部データソースについてこの上限を増やすことができますが、これはパブリック外部データソースの場合に選択できるオプションではありません。* [データソースの設定方法についてはこちらを参照してください](../datasource/about-data-sources.md)。

>[!NOTE]
>
>データソースで、データソースで使用されているものとは異なるエンドポイントを持つカスタム認証を使用する場合は、アドビに連絡して、そのエンドポイントも許可リストに含める必要があります。

**カスタムアクション**&#x200B;の場合は、外部 API の処理能力を評価しておく必要があります。例えば、Journey Optimizer が 1 秒あたり 1000 件の呼び出しを送信しているのに対して、システムが 1 秒あたり 200 件の呼び出ししかサポートできない場合、システムが飽和状態にならないようにキャップ設定またはスロットル設定を定義する必要があります。[詳しくは、アクションの設定方法を参照してください](../action/action.md)

>[!NOTE]
>
>応答がサポートされるようになったので、外部データソースのユースケースでは、データソースの代わりにカスタムアクションを使用する必要があります。応答について詳しくは、この[節](../action/action-response.md)を参照してください。

## 応答時間が遅いエンドポイント {#response-time}

エンドポイントの応答時間が 0.75 秒を超える場合、そのカスタムアクションの呼び出しは、デフォルトのサービスではなく、専用の&#x200B;**低速カスタムアクションサービス**&#x200B;を通じてルーティングされます。

この低速カスタムアクションサービスでは、30 秒ごとに 150,000 回の呼び出しというキャップ制限が適用されます。この制限は、30 秒間の任意のミリ秒から開始できるスライディングウィンドウを使用して適用されます。 ウィンドウがいっぱいになると、追加の呼び出しはキャップエラーで拒否されます。システムは、次の固定間隔を待たずに、30 秒のしきい値に達するとすぐにキャップを開始します。

低速エンドポイントは、パイプライン内のキュー内のすべてのアクションに遅延を引き起こす可能性があるので、応答時間が遅いエンドポイントでカスタムアクションを設定しないことをお勧めします。このようなアクションを低速サービスにルーティングすると、システム全体のパフォーマンスを保護し、他のカスタムアクションの待ち時間が増えるのを防ぐことができます。

## タイムアウトと再試行 {#timeout}

キャップルールまたはスロットルルールが満たされると、タイムアウトルールが適用されます。

各ジャーニーで、タイムアウト時間を定義できます。 これにより、外部システムを呼び出す時の最大時間を設定できます。 タイムアウト時間は、ジャーニーのプロパティで設定します。 [このページ](../building-journeys/journey-properties.md#timeout_and_error)を参照してください。

このタイムアウトは、すべての外部呼び出し（カスタムアクションおよびカスタムデータソースの外部 API 呼び出し）に対してグローバルに適用されます。デフォルトでは 30 分に設定されています。

定義されたタイムアウト時間中に、Journey Optimizer は外部システムの呼び出しを試みます。 最初の呼び出しの後、タイムアウト時間の終わりに達するまで、最大 3 回の再試行を実行できます。 再試行の回数は変更できません。

1 つの再試行は、1 つのスロットを使用します。1 秒あたり 100 回のキャップ（呼び出しのキャップ）があり、各呼び出しに 2 回の再試行が必要な場合、速度は 1 秒あたり 30 回に低下します（最初の呼び出しと 2 回の再試行で、呼び出しごとに次の 3 つのスロットが使用されます）。

タイムアウト時間の値は、使用例によって異なります。 クライアントがストアに入ったときなど、メッセージをすぐに送信したい場合は、長いタイムアウトを設定しません。 タイムアウトが長いほど、キューに入るアイテムも増えます。これは、パフォーマンスに大きな影響を与えます。 Journey Optimizer が 1 秒あたり 1000 回の呼び出しを実行する場合、データを 5 秒または 15 秒保持すると、システムがすぐに圧迫される可能性があります。

5 秒のタイムアウトの例を見てみましょう。

* 最初の呼び出しが 5 秒未満続く：呼び出しは成功し、再試行は実行されません。
* 最初の呼び出しが 5 秒以上続く：呼び出しがキャンセルされ、再試行はありません。 レポートでは、タイムアウトエラーとしてカウントされます。
* 最初の呼び出しが 2 秒後に失敗する（外部システムがエラーを返す）：キャップスロットが使用可能な場合、再試行の残り時間は 3 秒です。
   * 3 回の再試行のうち 1 回が 5 秒以内に成功した場合は、呼び出しが実行され、エラーは発生しません。
   * 再試行中にタイムアウト時間の終わりに達した場合、呼び出しはキャンセルされ、レポートではタイムアウトエラーとしてカウントされます。

## よくある質問{#faq}

**キャップルールまたはスロットルルールはどのようにして設定できますか？デフォルトのルールはありますか？**

キャップルールまたはスロットルルールを作成する方法について詳しくは、[この節](../configuration/external-systems.md#capping)を参照してください。デフォルトでは、スロットルルールはありませんが、すべてのカスタムアクションに対して、各ホストおよび各サンドボックスに、1 分間で 300,000 件の呼び出しというキャップが定義されています。この制限は、カスタムアクションの対象となる外部エンドポイントを保護することを目的に、顧客の使用状況に基づいて設定されています。必要に応じて、Capping API と Throttling API でキャップまたはスロットルキャップを大きく定義することで、この設定を上書きできます。

**再試行は何回行われますか？再試行の回数を変更したり、再試行間の最小待ち時間を定義したりできますか？**

特定の呼び出しに対しては、最初の呼び出しの後、タイムアウト時間の終わりに達するまで、最大 3 回の再試行を実行できます。 再試行の回数と各再試行間の時間は変更できません。 この[節](../configuration/external-systems.md#timeout)を参照してください。

**タイムアウトはどこで設定できますか？最大値はありますか？**

各ジャーニーで、タイムアウト時間を定義できます。 タイムアウト時間は、ジャーニーのプロパティで設定します。 タイムアウト時間は、1 秒から 30 秒の間にする必要があります。 この [節](../configuration/external-systems.md#timeout)と[このページ](../building-journeys/journey-properties.md#timeout_and_error)を参照してください。

**カスタムアクションを使用する際に、Journey Optimizer で開かれる接続の最大数はいくつですか？**

IP プロキシを有効にし、ターゲットエンドポイントでスロットル設定を定義した場合、接続数は次のレートに基づきます（推定値であり、保証される数値ではありません）。

* 200～2000 c/s：50 接続
* 2000～3000：75 接続
* 3000～4000：100 接続
* 4000～5000：125 接続

エンドポイントにスロットル設定が定義されていない場合、Journey Optimizer のエンジンはスケールアップするようにデザインされており、多数の接続（2,000 以上）に対応できます。接続数を制限するには、スロットル設定を使用する必要があります。
